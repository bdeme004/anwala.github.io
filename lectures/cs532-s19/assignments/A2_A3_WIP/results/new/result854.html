b'Ataques MitM e DoS a dom\xef\xbe\x83\xef\xbd\xadnios com o uso de certificados antigos\n6 fev 2019\nAmea\xef\xbe\x83\xef\xbd\xa7as\nCertificados HTTPS s\xef\xbe\x83\xef\xbd\xa3o um dos pilares da seguran\xef\xbe\x83\xef\xbd\xa7a na Internet. Mas nem tudo s\xef\xbe\x83\xef\xbd\xa3o flores. J\xef\xbe\x83\xef\xbd\xa1 falamos sobre como o sistema existente muitas vezes falha em proteger os usu\xef\xbe\x83\xef\xbd\xa1rios . Agora vamos focar no que pode dar errado para os propriet\xef\xbe\x83\xef\xbd\xa1rios de sites.\nDois certificados v\xef\xbe\x83\xef\xbd\xa1lidos para o mesmo dom\xef\xbe\x83\xef\xbd\xadnio\nRegistros de dom\xef\xbe\x83\xef\xbd\xadnio e certifica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o HTTPS s\xef\xbe\x83\xef\xbd\xa3o frequentemente controlados por organiza\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xb5es diferentes, ent\xef\xbe\x83\xef\xbd\xa3o o prazo de validade dos dom\xef\xbe\x83\xef\xbd\xadnios e dos certificados n\xef\xbe\x83\xef\xbd\xa3o ser\xef\xbe\x83\xef\xbd\xa3o necessariamente os mesmos. Isso permite casos em que tanto o antigo, quanto o atual dono de um dom\xef\xbe\x83\xef\xbd\xadnio possuem certificados v\xef\xbe\x83\xef\xbd\xa1lidos\xef\xbe\x82\xef\xa3\xb0ao mesmo tempo.\nO que pode dar errado em uma situa\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o como esta e qu\xef\xbe\x83\xef\xbd\xa3o recorrente \xef\xbe\x83\xef\xbd\xa9 esse problema na vida real? Na DEF COM 26 , os pesquisadores Ian Foster e Dylan Ayrey apresentarem seu estudo sobre a quest\xef\xbe\x83\xef\xbd\xa3o . De acordo com a dupla, h\xef\xbe\x83\xef\xbd\xa1 ainda mais complica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xb5es do que aquelas percebidas \xef\xbe\x83\xef\xa3\xb0 primeira vista \xe7\xaa\xb6 al\xef\xbe\x83\xef\xbd\xa9m de ser algo surpreendentemente comum.\nO problema mais \xef\xbe\x83\xef\xbd\xb3bvio \xef\xbe\x83\xef\xbd\xa9 exatamente aquilo que voc\xef\xbe\x83\xef\xbd\xaa esperaria que acontecesse se outra pessoa possu\xef\xbe\x83\xef\xbd\xadsse um certificado v\xef\xbe\x83\xef\xbd\xa1lido para o seu dom\xef\xbe\x83\xef\xbd\xadnio: um ataque \xe2\x80\x9c Man-in-the-Middle \xe2\x80\x9d nos usu\xef\xbe\x83\xef\xbd\xa1rios do seu site.\nFoster e Ayrey usaram a base de dados de certificados do projeto Certificate Transparency e identificaram 1,5 milh\xef\xbe\x83\xef\xbd\xa3o de casos de \xe2\x80\x9cpropriedade cruzada\xe2\x80\x9d \xe7\xaa\xb6 uma quantia que representa quase 0,5% de todos os sites. Em 25% destes casos, o certificado mais antigo ainda \xef\xbe\x83\xef\xbd\xa9 v\xef\xbe\x83\xef\xbd\xa1lido, o que torna 375 mil dom\xef\xbe\x83\xef\xbd\xadnios vulner\xef\xbe\x83\xef\xbd\xa1veis ao Man-in-the-Middle.\nMas isso n\xef\xbe\x83\xef\xbd\xa3o \xef\xbe\x83\xef\xbd\xa9 tudo. \xef\xbe\x83 bastante comum criar um certificado para m\xef\xbe\x83\xef\xbd\xbaltiplos dom\xef\xbe\x83\xef\xbd\xadnios \xe7\xaa\xb6 facilmente dezenas ou mesmo centenas deles. Por exemplo, Foster e Ayrey foram capazes de detectar um certificado que cobria 700 dom\xef\xbe\x83\xef\xbd\xadnios ao mesmo tempo, e de acordo com os pesquisadores, essa lista inclui diversos dom\xef\xbe\x83\xef\xbd\xadnios muito populares.\nSem nenhuma surpresa, alguns desses 700 dom\xef\xbe\x83\xef\xbd\xadnios est\xef\xbe\x83\xef\xbd\xa3o atualmente dispon\xef\xbe\x83\xef\xbd\xadveis; dessa forma, qualquer pessoa pode registrar e adquirir um certificado HTTPS para um deles. A quest\xef\xbe\x83\xef\xbd\xa3o agora \xef\xbe\x83\xef\xbd\xa9: o dono do novo dom\xef\xbe\x83\xef\xbd\xadnio tem o direito de revogar o certificado anterior para proteger sua p\xef\xbe\x83\xef\xbd\xa1gina de um ataque Man-in-the-Middle?\nCertificados podem ser revogados?\nCertificados podem, de fato, ser revogados. O procedimento operacional dos centros de certifica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o permite a anula\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o de certificados se \xe2\x80\x9cqualquer informa\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o contida no Certificado for incorreta ou enganosa\xe2\x80\x9d. Esse cancelamento deve acontecer at\xef\xbe\x83\xef\xbd\xa9 24 horas depois do recebimento da notifica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o.\nFoster e Ayrey observaram como isso funciona na vida real, e descobriram que o procedimento varia muito de acordo com os diferentes centros de certifica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o. Assim, o Let\xe2\x80\x99s Encrypt aplica ferramentas automatizadas que ajudam a revogar um certificado rapidamente \xe7\xaa\xb6 quase em tempo real. Em outros centros de certifica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o, voc\xef\xbe\x83\xef\xbd\xaa vai precisar entrar em contato com pessoas reais, ent\xef\xbe\x83\xef\xbd\xa3o n\xef\xbe\x83\xef\xbd\xa3o ser\xef\xbe\x83\xef\xbd\xa1 t\xef\xbe\x83\xef\xbd\xa3o r\xef\xbe\x83\xef\xbd\xa1pido. \xef\xbe\x83\xc2\x80s vezes, revogar um certificado requer perseveran\xef\xbe\x83\xef\xbd\xa7a e muito mais do que as 24 horas de espera estimadas. Nos piores casos, a anula\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o do certificado pode at\xef\xbe\x83\xef\xbd\xa9 mesmo n\xef\xbe\x83\xef\xbd\xa3o acontecer. Por exemplo, a comunica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o entre os pesquisadores e a Comodo terminou com uma sugest\xef\xbe\x83\xef\xbd\xa3o de \xe2\x80\x9cesquecer esse SSL e solicitar um novo SSL\xe2\x80\x9d.\nDe qualquer forma, \xef\xbe\x83\xef\xbd\xa9 mais prov\xef\xbe\x83\xef\xbd\xa1vel que consiga revogar um certificado antigo do que n\xef\xbe\x83\xef\xbd\xa3o. Essa not\xef\xbe\x83\xef\xbd\xadcia \xef\xbe\x83\xef\xbd\xa9 daquelas que pode ser boa ou n\xef\xbe\x83\xef\xbd\xa3o. Por um lado, o novo dono do dom\xef\xbe\x83\xef\xbd\xadnio vai na maioria das vezes ser capaz de se proteger contra um ataque Man-in-the-Middle que explora a vulnerabilidade de um certificado anterior. Por outro, significa que outra pessoa pode adquirir um dos dom\xef\xbe\x83\xef\xbd\xadnios gratuitos cobertos por um certificado \xe2\x80\x9ccompartilhado\xe2\x80\x9d e revog\xef\xbe\x83\xef\xbd\xa1-lo, o que vai prejudicar muito o uso dos demais sites associados.\nQu\xef\xbe\x83\xef\xbd\xa3o recorrente \xef\xbe\x83\xef\xbd\xa9 o problema? Ainda mais que o primeiro: 7 milh\xef\xbe\x83\xef\xbd\xb5es de dom\xef\xbe\x83\xef\xbd\xadnios \xe7\xaa\xb6 mais de 2% da Internet! \xe7\xaa\xb6 compartilham seus certificados com dom\xef\xbe\x83\xef\xbd\xadnios cujos registros j\xef\xbe\x83\xef\xbd\xa1 expiraram. 41% dos certificados anteriores ainda s\xef\xbe\x83\xef\xbd\xa3o v\xef\xbe\x83\xef\xbd\xa1lidos. Consequentemente, milh\xef\xbe\x83\xef\xbd\xb5es de dom\xef\xbe\x83\xef\xbd\xadnios est\xef\xbe\x83\xef\xbd\xa3o atualmente expostos a ataques DoS que usam a vulnerabilidade relacionada \xef\xbe\x83\xef\xa3\xb0 anula\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o do certificado.\nVamos voltar aos certificados de 700 dom\xef\xbe\x83\xef\xbd\xadnios mencionados acima. Para demonstrar qu\xef\xbe\x83\xef\xbd\xa3o urgente \xef\xbe\x83\xef\xbd\xa9 o problema, os pesquisadores adquiriram um dos dom\xef\xbe\x83\xef\xbd\xadnios gratuitos cobertos por esse certificado. Ent\xef\xbe\x83\xef\xbd\xa3o agora, teoricamente, eles podem lan\xef\xbe\x83\xef\xbd\xa7ar um ataque DoS em centenas de p\xef\xbe\x83\xef\xbd\xa1ginas ativas.\nComo se proteger?\nUm total de 375.000 dom\xef\xbe\x83\xef\xbd\xadnios est\xef\xbe\x83\xef\xbd\xa3o vulner\xef\xbe\x83\xef\xbd\xa1veis a ataques MitM e milh\xef\xbe\x83\xef\xbd\xb5es deles a ataques DoS por meio do uso de certificados antigos \xe7\xaa\xb6 e seus dom\xef\xbe\x83\xef\xbd\xadnios tamb\xef\xbe\x83\xef\xbd\xa9m podem estar na lista. Como o relat\xef\xbe\x83\xef\xbd\xb3rio foi apresentado em uma das maiores confer\xef\xbe\x83\xef\xbd\xaancias hacker do mundo, pode ter certeza \xe7\xaa\xb6 algu\xef\xbe\x83\xef\xbd\xa9m j\xef\xbe\x83\xef\xbd\xa1 est\xef\xbe\x83\xef\xbd\xa1 procurando dom\xef\xbe\x83\xef\xbd\xadnios vulner\xef\xbe\x83\xef\xbd\xa1veis, at\xef\xbe\x83\xef\xbd\xa9 mesmo enquanto l\xef\xbe\x83\xef\xbd\xaa este artigo. Mas como os propriet\xef\xbe\x83\xef\xbd\xa1rios de sites podem se proteger? Foster e Ayrey sugerem os seguintes passos:\nUtilize um header Expect-CT HTTP com uma regra \xe2\x80\x9cobrigat\xef\xbe\x83\xef\xbd\xb3ria\xe2\x80\x9d para garantir que apenas os certificados listados na base de dados do Certificate Transparency sejam confiados ao seu dom\xef\xbe\x83\xef\xbd\xadnio.\nUtilize a base de dados do Certificate Transparency para verificar se seus dom\xef\xbe\x83\xef\xbd\xadnios possuem certificados v\xef\xbe\x83\xef\xbd\xa1lidos emitidos por antigos donos. Pode fazer isso com a ferramenta de Monitoramento de transpar\xef\xbe\x83\xef\xbd\xaancia de certificado do Facebook. Para simplificar o trabalho, os pesquisadores disponibilizaram uma ferramenta pr\xef\xbe\x83\xef\xbd\xb3pria que pode ser usada por qualquer pessoa para pesquisar dom\xef\xbe\x83\xef\xbd\xadnios expostos \xef\xbe\x83\xef\xa3\xb0s vulnerabilidades descritas.\nN\xef\xbe\x83\xef\xbd\xb3s podemos dar mais algumas dicas:\nFa\xef\xbe\x83\xef\xbd\xa7a um invent\xef\xbe\x83\xef\xbd\xa1rio completo das suas p\xef\xbe\x83\xef\xbd\xa1ginas corporativas para ver se h\xef\xbe\x83\xef\xbd\xa1 qualquer certificado antigo para seus dom\xef\xbe\x83\xef\xbd\xadnios. Se encontrar algum, entre em contato com o centro de certifica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o e solicite a anula\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o.\nN\xef\xbe\x83\xef\xbd\xa3o adquira um certificado para m\xef\xbe\x83\xef\xbd\xbaltiplos dom\xef\xbe\x83\xef\xbd\xadnios, especialmente se for uma pr\xef\xbe\x83\xef\xbd\xa1tica comum da sua empresa criar diversos sites e dom\xef\xbe\x83\xef\xbd\xadnios associados sem um monitoramento de operabilidade rigoroso. Se o registro de um dom\xef\xbe\x83\xef\xbd\xadnio \xe2\x80\x9cabandonado\xe2\x80\x9d expirar e algu\xef\xbe\x83\xef\xbd\xa9m assumi-lo, tudo que precisar\xef\xbe\x83\xef\xbd\xa1 ser feito para derrubar sua p\xef\xbe\x83\xef\xbd\xa1gina corporativa \xef\xbe\x83\xef\xbd\xa9 revogar o certificado.\nPondere com anteced\xef\xbe\x83\xef\xbd\xaancia a situa\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o do certificado comprometido. Voc\xef\xbe\x83\xef\xbd\xaa ter\xef\xbe\x83\xef\xbd\xa1 que revog\xef\xbe\x83\xef\xbd\xa1-lo urgentemente e, de acordo com o estudo, alguns centros de certifica\xef\xbe\x83\xef\xbd\xa7\xef\xbe\x83\xef\xbd\xa3o s\xef\xbe\x83\xef\xbd\xa3o lerdos demais para responder \xe7\xaa\xb6 ent\xef\xbe\x83\xef\xbd\xa3o pode ser uma boa ideia escolher os mais r\xef\xbe\x83\xef\xbd\xa1pidos.\n'