<!DOCTYPE html>
<html>
<head>
	<title>Información De Carreteras</title>
	<meta charset="iso-8859-15" />
  <meta http-equiv="pragma" content="no-cache">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link rel="stylesheet" href="leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="../dist/leaflet.ie.css" /><![endif]-->
</head>
<body style="margin:0; padding:0;">
	<!--<div id="map" style="width: 600px; height: 400px"></div>-->
	<!--<div id="map" style="width: 100%; height: 800px;"></div>-->
	<div id="map" style="position: fixed; left: 0px; top: 0px; width: 100%; height: 100%;"></div>
  <script src="jquery-1.8.3.min.js"></script>
	<script src="leaflet.js"></script>		
	<script>
            var uri = 'http://infocar.dgt.es/etraffic';
		var cities = new L.LayerGroup();

	    L.marker([39.61, -105.02]).bindPopup('This is Littleton, CO.').addTo(cities),
		L.marker([39.74, -104.99]).bindPopup('This is Denver, CO.').addTo(cities),
		L.marker([39.73, -104.8]).bindPopup('This is Aurora, CO.').addTo(cities),
		L.marker([39.77, -105.23]).bindPopup('This is Golden, CO.').addTo(cities);        


	    var cmAttr = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade, DGT',
			//cmUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/{styleId}/256/{z}/{x}/{y}.png';
			cmUrl = 'http://{s}.tile.cloudmade.com/d18e464fd6b049739e484551537f990d/{styleId}/256/{z}/{x}/{y}.png';

	    var minimal   = L.tileLayer(cmUrl, {styleId: 22677, attribution: cmAttr}),
		    midnight  = L.tileLayer(cmUrl, {styleId: 999,   attribution: cmAttr}),
        //google = new L.TileLayer('http://mt{s}.google.com/vt/v=w2.106&x={x}&y={y}&z={z}&s=', { subdomains:'0123', attribution:'&copy; Google 2012' }),
        // google_layer = new L.Google("ROADMAP", {detectRetina: true}),
        // google_layer = L.gridLayer.googleMutant({ type: 'roadmap'}),
         // google_layer = new GoogleGridLayer(new L.Google("ROADMAP", {detectRetina: true})),
       // osm = new L.TileLayer("http://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution: 'Map Data &amp; Map Image &copy; <a href="http://www.openstreetmap.org/">OpenStreetMap</a> Contributors. <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC BY-SA 2.0</a>',maxZoom: 18}),
osm = new L.TileLayer("http://infocar.dgt.es/osm/{z}/{x}/{y}.png",{attribution: 'Map Data &amp; Map Image &copy; <a href="http://www.openstreetmap.org/">OpenStreetMap</a> Contributors. <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC BY-SA 2.0</a>',maxZoom: 18}),
		    motorways = L.tileLayer(cmUrl, {styleId: 46561, attribution: cmAttr});
// Get url parameters
var params = {};
window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
params[key] = value;
});
 
if (params.layers) {
var activeLayers = params.layers.split(',').map(function(item) { // map function not supported in IE < 9
return layers[item];
});
}
		var map = L.map('map', {
			center: [params.lat || 40.34602, params.lng || -3.82839],
			zoom: params.zoom || 5,
			layers: activeLayers || [osm]
		});
		
      var iconoDGT = L.icon({
        iconUrl: uri+'/img/logoDGT.gif',
        iconSize:     [105, 59], // size of the icon
       iconAnchor:   [100, 70], // point of the icon which will correspond to marker's location
       popupAnchor:  [-90, -80] // point from which the popup should open relative to the iconAnchor
      });
    var bounds = map.getBounds();
 var logo=L.marker([bounds._southWest.lat+2, bounds._northEast.lng],{icon: iconoDGT}).bindPopup('<a href="http://www.dgt.es/">www.dgt.es</a><br><br><a href="'+uri+'/Incidencias?caracter=acontecimiento&orden=fechahora_ini%20DESC&IncidenciasEVENTOS=IncidenciasEVENTOS&IncidenciasOTROS=IncidenciasOTROS&IncidenciasRETENCION=IncidenciasRETENCION&IncidenciasPUERTOS=IncidenciasPUERTOS&IncidenciasMETEOROLOGICA=IncidenciasMETEOROLOGICA&IncidenciasRESTRICCIONES=IncidenciasRESTRICCIONES">Listado Incidencias</a>'); 
logo.addTo(map);

        //var radares = new L.GeoJSON();
        //$.getJSON("radares.json",function(datos){
          //radares.addGeoJSON(datos);
        //});
        //map.addLayer(radares);
		
	</script>
<script type="text/javascript">

var incidencias = new L.LayerGroup();

$.getJSON(uri+"/BuscarElementos?",
  {
  	latNS:44.33956524809713,
    longNS:30.1904296875,
    latSW:26.745610382199022,
    longSW:-39.287109375,
    zoom:5,
    accion:'getElementos',
    Camaras:false,
    SensoresTrafico:false,
    SensoresMeteorologico:false,
    Paneles:false,
    IncidenciasRETENCION:true,
    IncidenciasOBRAS:false,
    IncidenciasMETEOROLOGICA:true,
    IncidenciasPUERTOS:true,
    IncidenciasOTROS:true,
    IncidenciasEVENTOS:true,
    IncidenciasRESTRICCIONES:true,
    niveles:false,
    caracter:'acontecimiento',
  },
  function(datos) {
  	//console.log(datos);
    $.each(datos, function(clave,objeto){
      //$("<img/>").attr("src", item.media.m).appendTo("#images");
      //if ( i == 3 ) return false;
      //console.log(clave + objeto.carretera);
      //$("<img/>").attr("src", item.media.m).appendTo("#images");
      //$('#carreteras').append('<p>'+objeto.carretera+'</p>');
      var iconoObjeto = L.icon({
        iconUrl: uri+'/img/iconosIncitar/'+objeto.icono,
        //shadowUrl: 'http://infocar.dgt.es/etraffic/img/ICONenMAPA/EQUIPmapCAMA.png',
        iconSize:     [30, 30], // size of the icon
        //shadowSize:   [50, 64], // size of the shadow
       iconAnchor:   [22, 22], // point of the icon which will correspond to marker's location
       //shadowAnchor: [4, 62],  // the same for the shadow
       popupAnchor:  [-3, -10] // point from which the popup should open relative to the iconAnchor
      });
      //var incidencia = L.marker([objeto.lat, objeto.lng],{icon: iconoObjeto}).addTo(map);
      //incidencia.bindPopup(objeto.descripcion);            
      L.marker([objeto.lat, objeto.lng],{icon: iconoObjeto}).bindPopup('<div id="div_popup" style="overflow: hidden;height: 1%;">'+objeto.descripcion+'</div>').addTo(incidencias)
    });
  });  
map.addLayer(incidencias);		
</script>

<script type="text/javascript">
	
var equipamiento = new L.LayerGroup();
var camaras = new L.LayerGroup();
var camara;

//console.log(map.getZoom());
function getEquipamiento()
{
camaras.eachLayer(function (camara) {
  camaras.removeLayer(camara);
});
equipamiento.eachLayer(function (equipo) {
  equipamiento.removeLayer(equipo);
});
//camaras = new L.LayerGroup();
var bounds = map.getBounds();
logo.setLatLng([bounds._southWest.lat, bounds._northEast.lng]);
$.getJSON(uri+"/BuscarElementos?",
  {
    latNS:bounds._northEast.lat,
    longNS:bounds._northEast.lng,
    latSW:bounds._southWest.lat,
    longSW:bounds._southWest.lng,
    zoom:map.getZoom(),
    accion:'getElementos',
    Camaras:true,
    SensoresTrafico:true,
    SensoresMeteorologico:true,
    Paneles:true,
    IncidenciasRETENCION:false,
    IncidenciasOBRAS:false,
    IncidenciasMETEOROLOGICA:false,
    IncidenciasPUERTOS:false,
    IncidenciasOTROS:false,
    IncidenciasEVENTOS:false,
    niveles:false,
    caracter:'acontecimiento',
  },
  function(datos) {
  	//console.log(datos);
    $.each(datos, function(clave,objeto){
      //$("<img/>").attr("src", item.media.m).appendTo("#images");
      //if ( i == 3 ) return false;
      //console.log(clave + objeto.carretera);
      //$("<img/>").attr("src", item.media.m).appendTo("#images");
      //$('#carreteras').append('<p>'+objeto.carretera+'</p>');
      var iconoObjeto = L.icon({
        iconUrl: uri+'/img/iconosIncitar/'+objeto.icono,
        //shadowUrl: 'http://infocar.dgt.es/etraffic/img/ICONenMAPA/EQUIPmapCAMA.png',
        iconSize:     [30, 30], // size of the icon
        //shadowSize:   [50, 64], // size of the shadow
       iconAnchor:   [22, 22], // point of the icon which will correspond to marker's location
       //shadowAnchor: [4, 62],  // the same for the shadow
       popupAnchor:  [-3, -10] // point from which the popup should open relative to the iconAnchor
      });
      //var incidencia = L.marker([objeto.lat, objeto.lng],{icon: iconoObjeto}).addTo(map);
      //incidencia.bindPopup(objeto.descripcion);            
      //L.marker([objeto.lat, objeto.lng],{icon: iconoObjeto}).bindPopup(objeto.descripcion).addTo(equipamiento)
      if (objeto.tipo == "Camara"){       
        //console.log(objeto);
        //camara = L.marker([objeto.lat, objeto.lng]).bindPopup(objeto.tipo).addTo(camaras);
      var iconoCamara = L.icon({
        iconUrl: uri+'/img/ICONenMAPA/EQUIPmapCAMA.png',
        shadowUrl: uri+'/img/ICONenMAPA/EQUIPmapSOMB.png',
        iconSize:     [35, 38], // size of the icon
        shadowSize:   [35, 38], // size of the shadow
       //iconAnchor:   [35, 38], // point of the icon which will correspond to marker's location
       //shadowAnchor: [35, 38],  // the same for the shadow
       popupAnchor:  [-3, -10] // point from which the popup should open relative to the iconAnchor
      }); 
        $.getJSON(uri+"/BuscarElementos?",
        {
          accion:'getDetalles',
          codEle:objeto.codEle,
          tipo:'Camara',
          indiceMapa:0,
         },
         function(data) {
          //L.marker([objeto.lat, objeto.lng],{icon: iconoCamara}).bindPopup('<p><b>Id '+data.tipo+':</b>'+objeto.alias+' <b>Fecha:  </b> '+data.fecha+'</p><img width="100" src="'+uri+'/data/camaras/'+data.imagen+'?horaAct=1354617018168">',{maxWidth:800, autoPan:true}).addTo(camaras)
          L.marker([objeto.lat, objeto.lng],{icon: iconoCamara}).bindPopup('<p><b>'+objeto.alias+'</b></p><img width="235" height="180" src="'+uri+'/data/camaras/'+data.imagen+'?horaAct=1354617018168">',{maxWidth:800, autoPan:true}).addTo(camaras)
         }); 
        //L.marker([objeto.lat, objeto.lng]).on('click', currentMarker.openPopup.bind(currentMarker)).addTo(camaras);
      }else{
	L.marker([objeto.lat, objeto.lng]).bindPopup(objeto.tipo).addTo(equipamiento)
      }


    });
  });  
//map.addLayer(equipamiento);
map.addLayer(camaras);
}
getEquipamiento();		
</script>

<script type="text/javascript">

var obras = new L.LayerGroup();

$.getJSON(uri+"/BuscarElementos?",
  {
  	latNS:44.33956524809713,
    longNS:30.1904296875,
    latSW:26.745610382199022,
    longSW:-39.287109375,
    zoom:5,
    accion:'getElementos',
    Camaras:false,
    SensoresTrafico:false,
    SensoresMeteorologico:false,
    Paneles:false,
    IncidenciasRETENCION:false,
    IncidenciasOBRAS:true,
    IncidenciasMETEOROLOGICA:false,
    IncidenciasPUERTOS:false,
    IncidenciasOTROS:false,
    IncidenciasEVENTOS:false,
    niveles:false,
    caracter:'acontecimiento',
  },
  function(datos) {
  	//console.log(datos);
    $.each(datos, function(clave,objeto){
      //$("<img/>").attr("src", item.media.m).appendTo("#images");
      //if ( i == 3 ) return false;
      //console.log(clave + objeto.carretera);
      //$("<img/>").attr("src", item.media.m).appendTo("#images");
      //$('#carreteras').append('<p>'+objeto.carretera+'</p>');
      var iconoObjeto = L.icon({
        iconUrl: 'http://infocar.dgt.es/etraffic/img/iconosIncitar/'+objeto.icono,
        //shadowUrl: 'http://infocar.dgt.es/etraffic/img/ICONenMAPA/EQUIPmapCAMA.png',
        iconSize:     [30, 30], // size of the icon
        //shadowSize:   [50, 64], // size of the shadow
       iconAnchor:   [22, 22], // point of the icon which will correspond to marker's location
       //shadowAnchor: [4, 62],  // the same for the shadow
       popupAnchor:  [-3, -10] // point from which the popup should open relative to the iconAnchor
      });
      //var incidencia = L.marker([objeto.lat, objeto.lng],{icon: iconoObjeto}).addTo(map);
      //incidencia.bindPopup(objeto.descripcion);            
      L.marker([objeto.lat, objeto.lng],{icon: iconoObjeto}).bindPopup('<div id="div_popup" style="overflow: hidden;height: 1%;">'+objeto.descripcion+'</div>').addTo(obras)
    });
  });
if (params.zoom > 9){
        map.addLayer(obras);
};
</script>
<script>	
		var baseLayers = {
	//		"CloudMade": minimal,
//			"CloudMade Noche": midnight,
		//	"Google": google_layer,
                        "OpenStreetMap": osm
		};

		var overlays = {
			//"Carreteras": motorways,
			"Incidencias":incidencias,
			"Camaras":camaras,
                        //"Radares":radares,
			//"Equipos":equipamiento,
			"Obras":obras,
		};

    control = L.control.layers(baseLayers, overlays);
    control.setPosition('bottomleft');
    control.addTo(map);			
		

map.on('dragend', function(e) {
    //alert(e.latlng); // e is an event object (MouseEvent in this case)
    getEquipamiento();
});

map.on('zoomend', function(e) {
    //alert(e.latlng); // e is an event object (MouseEvent in this case)
    var zoomActual = map.getZoom();
    if (zoomActual > 9){
        map.addLayer(obras);
    }else if(zoomActual < 10){
        map.removeLayer(obras);
    };
    getEquipamiento();
});

map.on('moveend', function(e) {
    //alert(e.latlng); // e is an event object (MouseEvent in this case)
    var bounds = map.getBounds();
    logo.setLatLng([bounds._southWest.lat, bounds._northEast.lng]);
});
map.on('click', function(e) {
    //alert(e.latlng); // e is an event object (MouseEvent in this case)
    //camaras.removeLayer(camarasMostradas[0]);

    //camaras.eachLayer(function (camara) {
    //    camaras.removeLayer(camara);
    //});
    //getEquipamiento();
});
</script>

	
</body>
</html>
